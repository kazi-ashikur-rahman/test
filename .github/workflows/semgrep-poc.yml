name: Semgrep PR Scan on Changed Files

on:
  pull_request:
    branches:
      - main
      - stg
      - dev

permissions:
  pull-requests: write
  contents: read

jobs:
  semgrep:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: python -m pip install --upgrade pip semgrep

      - name: Get changed lines
        id: changes
        run: |
          BASE_BRANCH=${{ github.event.pull_request.base.ref }}
          echo "Base branch: $BASE_BRANCH"

          git fetch origin $BASE_BRANCH
          
          git diff --unified=3 --ignore-space-change origin/$BASE_BRANCH...HEAD > changed.diff
          echo "Generated diff file:"
          head -n 50 changed.diff

      - name: Run Semgrep on all changed files
        run: |
          echo "ğŸ” Running Semgrep..."
          semgrep --config auto --json --output semgrep-report.json

      - name: Filter results to changed lines
        run: |
          python - <<'PY'
          import json, re

          report = json.load(open('semgrep-report.json'))
          results = report.get('results', [])
          
          diff_map = {}
          current_file = None

          print("Parsing diff file...")
          
          with open('changed.diff', 'r') as f:
              diff_lines = f.readlines()

          i = 0
          while i < len(diff_lines):
              line = diff_lines[i].strip()
              
              if line.startswith("+++ b/"):
                  current_file = line[6:].strip()
                  diff_map[current_file] = set()
                  print(f"Found file: {current_file}")
              
              elif line.startswith("@@") and current_file:
                  # Extract new file line information
                  match = re.search(r'@@ -\d+(?:,\d+)? \+(\d+)(?:,(\d+))? @@', line)
                  if match:
                      new_start = int(match.group(1))
                      new_count = int(match.group(2)) if match.group(2) else 1
                      
                      print(f"  Hunk: +{new_start},{new_count}")
                      
                      j = i + 1
                      current_new_line = new_start
                      
                      while j < len(diff_lines):
                          hunk_line = diff_lines[j]
                          
                          if hunk_line.startswith('@@') or hunk_line.startswith('+++') or hunk_line.startswith('---'):
                              break
                          
                          if hunk_line.startswith('+') and not hunk_line.startswith('+++'):
                              diff_map[current_file].add(current_new_line)
                              current_new_line += 1
                          elif hunk_line.startswith('-') and not hunk_line.startswith('---'):
                              pass
                          elif hunk_line.startswith(' '):
                              current_new_line += 1
                          elif hunk_line.strip() == '':
                              break
                              
                          j += 1
                      
                      i = j - 1  
              
              i += 1

          print("\nDetected changed lines:")
          for file, lines in diff_map.items():
              if lines:
                  sorted_lines = sorted(lines)
                  print(f"  {file}: {sorted_lines}")
                  if len(sorted_lines) > 1:
                      print(f"    Range: {min(sorted_lines)}-{max(sorted_lines)}")

          filtered = []
          print(f"\nFiltering {len(results)} Semgrep findings...")
          
          for r in results:
              path = r.get("path")
              start_line = r.get("start", {}).get("line")
              end_line = r.get("end", {}).get("line", start_line)
              
              if path in diff_map:
                  finding_lines = set(range(start_line, end_line + 1))
                  changed_lines = diff_map[path]
                  
                  if finding_lines & changed_lines:  # Set intersection
                      overlapping_lines = sorted(finding_lines & changed_lines)
                      print(f"  âœ“ Keeping finding in {path}:{start_line}-{end_line} (overlaps with changed lines: {overlapping_lines})")
                      r['overlapping_changed_lines'] = overlapping_lines
                      filtered.append(r)
                  else:
                      print(f"  âœ— Skipping finding in {path}:{start_line}-{end_line} (no overlap with changed lines)")
              else:
                  print(f"  âœ— Skipping finding in {path} (file not in changed files)")

          report['results'] = filtered
          report['debug_info'] = {
              'total_original_findings': len(results),
              'filtered_findings': len(filtered),
              'changed_files': {k: sorted(v) for k, v in diff_map.items() if v}
          }
          
          json.dump(report, open('semgrep-report.json','w'), indent=2)
          print(f"\nFinal result: {len(filtered)} findings (from {len(results)} total)")
          PY

      - name: Build Markdown summary
        run: |
          python - <<'PY'
          import json
          try:
              report = json.load(open('semgrep-report.json'))
          except Exception as e:
              open('semgrep_report.md','w').write(f"â— Failed to read semgrep output: {e}")
              raise

          results = report.get('results', []) or []
          debug_info = report.get('debug_info', {})
          
          if not results:
              md = "âœ… **Semgrep:** No issues found in changed code lines.\n\n"
              if debug_info.get('total_original_findings', 0) > 0:
                  md += f"_Note: {debug_info['total_original_findings']} findings were found in changed files but not in the lines you modified._"
          else:
              md = f"ğŸš¨ **Semgrep Scan** found **{len(results)}** issue(s) in your changed code lines\n\n"
              
              # Show debug info
              if debug_info:
                  md += f"ğŸ“Š **Scan Summary:**\n"
                  md += f"- Total findings in changed files: {debug_info.get('total_original_findings', 0)}\n"
                  md += f"- Findings in your modified lines: {len(results)}\n\n"
              
              # Show changed files and lines for transparency
              if debug_info.get('changed_files'):
                  md += f"ğŸ“ **Your Changes:**\n"
                  for file, lines in debug_info['changed_files'].items():
                      if lines:
                          line_ranges = []
                          if len(lines) == 1:
                              line_ranges.append(str(lines[0]))
                          else:
                              # Group consecutive lines into ranges
                              start = lines[0]
                              end = lines[0]
                              for line in lines[1:]:
                                  if line == end + 1:
                                      end = line
                                  else:
                                      if start == end:
                                          line_ranges.append(str(start))
                                      else:
                                          line_ranges.append(f"{start}-{end}")
                                      start = end = line
                              if start == end:
                                  line_ranges.append(str(start))
                              else:
                                  line_ranges.append(f"{start}-{end}")
                          
                          md += f"- `{file}`: lines {', '.join(line_ranges)}\n"
                  md += "\n"
              
              # Group findings by severity
              counts = {}
              lines = []
              for r in results:
                  rule = r.get('check_id') or r.get('rule_id') or 'unknown'
                  msg = r.get('extra', {}).get('message') or r.get('message','').strip()
                  path = r.get('path') or 'unknown'
                  line = r.get('start', {}).get('line') or ''
                  severity = (r.get('extra', {}).get('severity') or 'INFO').upper()
                  overlapping_lines = r.get('overlapping_changed_lines', [])
                  
                  counts[severity] = counts.get(severity,0)+1
                  
                  severity_emoji = "ğŸ”´" if severity == "ERROR" else "ğŸŸ¡" if severity == "WARNING" else "ğŸ”µ"
                  overlap_info = f" (affects your lines: {', '.join(map(str, overlapping_lines))})" if overlapping_lines else ""
                  
                  lines.append(f"- {severity_emoji} **{severity}** `{rule}` â€” {msg}  \n  ğŸ“ `{path}:{line}`{overlap_info}")

              md += "**Severity Breakdown:**\n" + "\n".join([f"- {k}: {v}" for k,v in counts.items()]) + "\n\n"
              md += "**Issues Found:**\n" + "\n".join(lines)
              md += "\n\nğŸ’¡ **Please review and fix these issues in your changed code before merging.**"

          open('semgrep_report.md','w').write(md)
          print(md)
          PY

      - name: Post PR comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: semgrep_report.md
